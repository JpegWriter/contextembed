// Prisma Schema for ContextEmbed
// Database: PostgreSQL (Supabase compatible)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users & Authentication
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  
  profile   UserProfile?
  projects  Project[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ============================================
// User Profile (Business Defaults)
// ============================================

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // Business Identity (used as defaults for all projects)
  businessName          String?
  tagline               String?
  industry              String?
  niche                 String?
  services              String?   // Comma-separated
  targetAudience        String?
  brandVoice            String?
  
  // Location Defaults
  city                  String?
  state                 String?
  country               String?
  serviceArea           String?
  
  // Authority (used for EEAT)
  yearsExperience       String?
  credentials           String?
  specializations       String?
  awardsRecognition     String?
  clientTypes           String?
  keyDifferentiator     String?
  pricePoint            String?
  brandStory            String?   @db.Text
  
  // Rights Defaults (inherited by all projects)
  creatorName           String?
  copyrightTemplate     String?   // e.g., "© {year} {businessName}. All rights reserved."
  creditTemplate        String?   // e.g., "{businessName} | {creatorName}"
  usageTerms            String?   @db.Text
  website               String?
  contactEmail          String?
  
  // Preferences
  primaryLanguage       String    @default("en")
  keywordStyle          String    @default("mixed")
  maxKeywords           Int       @default(15)
  defaultEventType      String?
  typicalDeliverables   String?
  
  // Onboarding status
  onboardingCompleted   Boolean   @default(false)
  completedAt           DateTime?
  
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@map("user_profiles")
}

// ============================================
// Workspaces & Billing
// ============================================

model Workspace {
  id            String   @id @default(cuid())
  ownerUserId   String
  name          String   @default("My Workspace")
  
  members       WorkspaceMember[]
  subscription  Subscription?
  projects      Project[]
  domainUsages  DomainUsage[]
  usageEvents   UsageEvent[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([ownerUserId])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(member)
  
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([workspaceId, userId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceRole {
  owner
  admin
  member
}

model Subscription {
  id                    String   @id @default(cuid())
  workspaceId           String   @unique
  
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  status                SubscriptionStatus @default(inactive)
  plan                  SubscriptionPlan   @default(free)
  currentPeriodEnd      DateTime?
  
  workspace             Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  inactive
  trialing
  active
  past_due
  canceled
  unpaid
}

enum SubscriptionPlan {
  free
  pro
  agency
}

model DomainUsage {
  id                  String   @id @default(cuid())
  workspaceId         String
  userId              String
  registrableDomain   String
  freeUsesConsumed    Int      @default(0)
  
  firstSeenAt         DateTime @default(now())
  lastSeenAt          DateTime @default(now())
  lastIpHash          String?
  lastDeviceId        String?
  
  status              DomainUsageStatus @default(active)
  blockReason         String?
  
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  
  @@unique([workspaceId, registrableDomain])
  @@index([userId])
  @@index([registrableDomain])
  @@map("domain_usage")
}

enum DomainUsageStatus {
  active
  throttled
  blocked
}

model UsageEvent {
  id                  String   @id @default(cuid())
  workspaceId         String
  userId              String
  projectId           String?
  
  action              UsageAction
  registrableDomain   String?
  imagesCount         Int?
  bytesTotal          BigInt?
  success             Boolean  @default(false)
  errorCode           String?
  
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  
  @@index([workspaceId])
  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
  @@map("usage_events")
}

enum UsageAction {
  run_ce
  export
  web_pack
  survival
}

// ============================================
// Projects & Onboarding
// ============================================

model Project {
  id                        String   @id @default(cuid())
  userId                    String
  workspaceId               String?
  name                      String
  goal                      ProjectGoal
  onboardingCompleted       Boolean  @default(false)
  
  // Primary domain for usage tracking (eTLD+1)
  primaryDomain             String?
  
  // Retention policy (free tier = 24h expiry)
  retentionPolicy           RetentionPolicy @default(free_24h)
  retentionHours            Int      @default(24)
  expiresAt                 DateTime?
  lastActivityAt            DateTime @default(now())
  
  // Governance settings
  visualAuthenticityPolicy  VisualAuthenticityPolicy?  // NULL = 'conditional' in code
  startupModeEnabled        Boolean  @default(false)   // When true, policy locked to 'deny_ai_proof'
  
  // Public verification settings (quiet, dispute-only)
  publicVerificationDefaultEnabled Boolean @default(false)  // Default OFF, opt-in only
  embedVerificationLink     Boolean  @default(false)        // Embed verification URL in exports
  
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace                 Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  onboardingProfile         OnboardingProfile?
  assets                    Asset[]
  jobs                      Job[]
  exports                   Export[]
  growthImages              GrowthImage[]
  wordpressConfig           WordPressConfig?
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@index([userId])
  @@index([workspaceId])
  @@index([expiresAt])
  @@map("projects")
}

enum RetentionPolicy {
  free_24h
  pro_7d
  agency_14d
  unlimited
}

enum VisualAuthenticityPolicy {
  conditional      // Default: AI-generated images allowed for decorative roles only
  deny_ai_proof    // Strict: Block AI-generated images from proof/hero roles
  allow            // Permissive: Allow AI images anywhere (with warning)
}

enum ProjectGoal {
  seo_aeo
  archive
  delivery
  stock
  social
}

model OnboardingProfile {
  id                String   @id @default(cuid())
  projectId         String   @unique
  version           Int      @default(1)
  
  // Stage 1: Project basics
  projectName       String
  primaryGoal       ProjectGoal
  
  // Stage 2: URL Audit
  websiteUrl        String?
  urlAuditResult    Json?    // UrlAuditResult
  confirmedContext  Json     // ConfirmedContext
  
  // Stage 3: Rights
  rights            Json     // RightsInfo
  
  // Stage 4: Preferences
  preferences       Json     // OutputPreferences
  
  // Tracking
  completenessScore Int      @default(0)
  isComplete        Boolean  @default(false)
  
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  metadataResults   MetadataResult[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("onboarding_profiles")
}

// ============================================
// Assets
// ============================================

model Asset {
  id               String      @id @default(cuid())
  projectId        String
  
  // File info
  filename         String
  originalFilename String
  mimeType         String
  size             Int
  hash             String
  
  // Storage paths
  storagePath      String
  thumbnailPath    String?
  previewPath      String?
  analysisPath     String?
  
  // Type tracking (for RAW support later)
  originalType     String      @default("jpeg")
  proxyType        String?
  
  // Dimensions
  width            Int?
  height           Int?
  
  // Status
  status           AssetStatus @default(pending)
  userComment      String?
  
  // Relations
  project          Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  visionResults    VisionResult[]
  metadataResults  MetadataResult[]
  embedResults     EmbedResult[]
  jobs             Job[]
  exportAssets     ExportAsset[]
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  
  @@index([projectId])
  @@index([status])
  @@index([hash])
  @@map("assets")
}

enum AssetStatus {
  pending
  preprocessing
  analyzing
  synthesizing
  embedding
  verifying
  completed
  failed
  approved
}

// ============================================
// Jobs
// ============================================

model Job {
  id          String    @id @default(cuid())
  projectId   String
  assetId     String?
  
  type        JobType
  status      JobStatus @default(pending)
  progress    Int       @default(0)
  error       String?
  metadata    Json?
  
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset       Asset?    @relation(fields: [assetId], references: [id], onDelete: SetNull)
  
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([projectId])
  @@index([assetId])
  @@index([status])
  @@index([type])
  @@map("jobs")
}

enum JobType {
  preprocess
  vision_analysis
  metadata_synthesis
  embed
  verify
  full_pipeline
  url_audit
  export
}

enum JobStatus {
  pending
  running
  completed
  failed
  cancelled
}

// ============================================
// Results
// ============================================

model VisionResult {
  id              String   @id @default(cuid())
  assetId         String
  
  modelId         String
  promptVersion   String
  inputHash       String
  result          Json     // VisionAnalysis
  tokensUsed      Int
  processingTimeMs Int
  
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  metadataResults MetadataResult[]
  
  createdAt       DateTime @default(now())
  
  @@index([assetId])
  @@map("vision_results")
}

model MetadataResult {
  id                   String   @id @default(cuid())
  assetId              String
  visionResultId       String
  onboardingProfileId  String
  
  modelId              String
  promptVersion        String
  inputHash            String
  result               Json     // SynthesizedMetadata
  tokensUsed           Int
  processingTimeMs     Int
  
  asset                Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  visionResult         VisionResult      @relation(fields: [visionResultId], references: [id], onDelete: Cascade)
  onboardingProfile    OnboardingProfile @relation(fields: [onboardingProfileId], references: [id], onDelete: Cascade)
  embedResults         EmbedResult[]
  
  createdAt            DateTime @default(now())
  
  @@index([assetId])
  @@index([visionResultId])
  @@map("metadata_results")
}

model EmbedResult {
  id                  String   @id @default(cuid())
  assetId             String
  metadataResultId    String
  
  embeddedPath        String
  embeddedStorageUrl  String?
  fieldsWritten       String[]
  exiftoolLogs        String
  verified            Boolean  @default(false)
  verificationDetails Json?
  
  asset             Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  metadataResult    MetadataResult @relation(fields: [metadataResultId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@index([assetId])
  @@index([metadataResultId])
  @@map("embed_results")
}

// ============================================
// Exports
// ============================================

model Export {
  id                String       @id @default(cuid())
  projectId         String
  
  destinationType   ExportDestinationType
  destinationConfig Json?
  status            ExportStatus @default(pending)
  outputPath        String?
  error             String?
  
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exportAssets      ExportAsset[]
  
  createdAt         DateTime     @default(now())
  completedAt       DateTime?
  
  @@index([projectId])
  @@map("exports")
}

model ExportAsset {
  id        String @id @default(cuid())
  exportId  String
  assetId   String
  
  export    Export @relation(fields: [exportId], references: [id], onDelete: Cascade)
  asset     Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  @@unique([exportId, assetId])
  @@map("export_assets")
}

enum ExportDestinationType {
  download
  folder
  cloud
}

enum ExportStatus {
  pending
  processing
  completed
  failed
}

// ============================================
// Usage Tracking (for billing later)
// ============================================

model UsageLog {
  id          String   @id @default(cuid())
  projectId   String
  jobId       String?
  
  type        UsageType
  units       Int
  modelId     String?
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([projectId])
  @@index([createdAt])
  @@map("usage_logs")
}

enum UsageType {
  vision_tokens
  llm_tokens
  storage_bytes
  export_count
}

// ============================================
// IA Content OS - Information Architecture
// ============================================

model IAPlan {
  id                String   @id @default(cuid())
  version           String
  productName       String
  oneLiner          String
  corePromise       String
  differentiators   String[]
  guardrails        String[]
  
  // Cadence configuration
  cadenceConfig     Json     // { moneyPagesPerMonth, supportPostsPerMonth, etc. }
  roleDefinitions   Json     // { money: "...", pillar: "...", etc. }
  
  // Brand mention strategy
  brandMentionGoal  String
  brandMentionRules String[]
  allowedMentions   String[]
  
  // Calendar config
  timezone          String   @default("UTC")
  startMonth        String   // YYYY-MM
  
  // Computed metrics
  coverageScore     Int      @default(0)
  
  // Relations
  pages             IAPage[]
  calendarItems     IACalendarItem[]
  linkRules         IAInternalLinkRule[]
  mentionsPolicies  IAMentionsPolicy[]
  
  importedAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("ia_plans")
}

model IAPage {
  id               String   @id @default(cuid())
  planId           String
  
  pageId           String   // e.g., "mp_pricing", "p_metadata_for_seo"
  role             IAPageRole
  title            String
  slug             String
  
  // Optional fields based on role
  primaryIntent    String?  // For money pages
  cta              String?  // For money pages
  goal             String?  // For pillars
  supportingTopics String[] // For pillars
  moneyLinkTarget  String?  // For pillars
  internalLinksOut String[]
  
  // Content status
  contentStatus    IAContentStatus @default(planned)
  draftPath        String?
  publishedUrl     String?
  
  plan             IAPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([planId, pageId])
  @@index([planId])
  @@index([role])
  @@index([slug])
  @@map("ia_pages")
}

enum IAPageRole {
  money
  pillar
  trust
  support
  caseStudy
  release
}

enum IAContentStatus {
  planned
  draft
  review
  published
  archived
}

model IACalendarItem {
  id           String   @id @default(cuid())
  planId       String
  
  month        String   // YYYY-MM
  theme        String
  week         Int      // 1-5
  type         IACalendarType
  title        String
  slug         String
  primaryLinks String[]
  
  // Mention tracking
  adobeMention Boolean  @default(false)
  mentionNote  String?
  
  // Content status
  contentStatus IAContentStatus @default(planned)
  draftPath     String?
  publishedUrl  String?
  publishedAt   DateTime?
  
  plan         IAPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([planId])
  @@index([month])
  @@index([type])
  @@index([contentStatus])
  @@map("ia_calendar_items")
}

enum IACalendarType {
  money
  support
  trust
  trust_or_release
  caseStudy
  release
}

model IAInternalLinkRule {
  id           String   @id @default(cuid())
  planId       String
  
  ruleType     IALinkRuleType
  sourcePageId String?  // null for global rules
  targetPageId String?  // null for global rules
  required     Boolean  @default(true)
  minLinks     Int      @default(1)
  description  String
  
  plan         IAPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([planId])
  @@index([ruleType])
  @@map("ia_internal_link_rules")
}

enum IALinkRuleType {
  global
  page_specific
}

model IAMentionsPolicy {
  id              String   @id @default(cuid())
  planId          String
  
  brand           String   // e.g., "Adobe"
  maxPerMonth     Int      @default(1)
  allowedContexts String[]
  rules           String[]
  
  plan            IAPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([planId])
  @@index([brand])
  @@map("ia_mentions_policies")
}

// ============================================
// Growth Plan Images (for governance & retry flow)
// ============================================

model GrowthImage {
  id              String   @id @default(cuid())
  projectId       String
  
  // File info
  filename        String
  originalFilename String
  mimeType        String
  size            Int
  storagePath     String
  
  // Role classification
  role            GrowthImageRole @default(proof)
  
  // AI detection
  aiGenerated     Boolean?        // null = not yet analyzed
  aiConfidence    Float?          // 0-1 confidence score
  aiDetectionModel String?        // Model used for detection
  
  // Governance
  governanceStatus   GrowthImageGovernance @default(pending)
  governanceReason   String?
  
  // Decision log (JSON array of log entries)
  decisionLog     Json      @default("[]")
  
  // Public verification (quiet, dispute-only)
  publicVerificationEnabled Boolean?    // null = inherit from project default
  verificationToken          String?    @unique @db.Uuid  // UUID token for verification endpoint
  verificationCreatedAt      DateTime?  @db.Timestamptz
  verificationRevokedAt      DateTime?  @db.Timestamptz
  verificationLastCheckedAt  DateTime?  @db.Timestamptz
  
  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  verificationLogs VerificationLog[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([projectId])
  @@index([governanceStatus])
  @@index([role])
  @@index([verificationToken])
  @@map("growth_images")
}

enum GrowthImageRole {
  proof       // Case study, testimonial, portfolio proof (requires real photos)
  hero        // Homepage/landing hero images (requires real photos in strict mode)
  decorative  // Blog illustrations, backgrounds (AI allowed)
  stock       // Licensed stock photography
}

enum GrowthImageGovernance {
  pending     // Not yet evaluated
  approved    // Passed governance check
  blocked     // Blocked by policy
  warning     // Allowed with warning
}

// ============================================
// Authorship Integrity Engine
// ============================================

/// Finite state machine for authorship classification.
/// Exactly ONE state per image. Assigned ON INGEST. Immutable unless re-ingested.
enum AuthorshipStatus {
  VERIFIED_ORIGINAL   // EXIF present + creator matches CE user
  DECLARED_BY_USER    // User self-declared, not machine-verified
  UNVERIFIED          // Default / conflicting / no evidence
  SYNTHETIC_AI        // AI-generated content detected
}

/// Current truth state for each image in the Authorship Integrity Engine.
model CeImage {
  id                    String           @id @default(cuid())
  userId                String
  projectId             String?
  assetId               String?          @unique  // Links to Asset model
  
  // File identity
  sha256                String           // Content hash for deduplication
  sourceType            String           @default("upload") // upload | api | wp | dam
  
  // Authorship state (finite state machine)
  authorshipStatus      AuthorshipStatus @default(UNVERIFIED)
  authorshipEvidence    Json             @default("{}") // Structured evidence summary
  userDeclared          Boolean          @default(false)
  syntheticConfidence   Float?           // 0-1 AI detection confidence
  
  // Classification metadata
  classifiedAt          DateTime?
  classifiedBy          String?          // "system" | "user"
  
  // Relations
  events                CeEventLog[]
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([assetId])
  @@index([authorshipStatus])
  @@index([sha256])
  @@map("ce_images")
}

/// One record per export attempt. Tracks validation, blocking, and completion.
model CeExport {
  id                    String           @id @default(cuid())
  userId                String
  projectId             String?
  
  // Export details
  exportType            String           // metadata | case_study | wp_post | aeo_block
  status                String           @default("started") // started | validated | blocked | completed | failed
  reasonCodes           String[]         // e.g. ["LANGUAGE_VIOLATION", "AUTHORSHIP_CLAIM_BLOCKED"]
  payloadHash           String?          // For deduplication
  resultRefs            Json?            // { wp_post_id, wp_url, file_paths, etc. }
  
  // Relations
  events                CeEventLog[]
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([exportType])
  @@map("ce_exports")
}

/// Append-only audit trail for all governance-significant actions.
model CeEventLog {
  id                    String           @id @default(cuid())
  userId                String
  projectId             String?
  imageId               String?          // FK to CeImage
  exportId              String?          // FK to CeExport
  
  // Event classification
  eventType             String           // image_ingested, authorship_classified, etc.
  eventVersion          Int              @default(1)
  
  // Structured event data (small, never raw EXIF dumps)
  details               Json             @default("{}")
  
  // Relations
  ceImage               CeImage?         @relation(fields: [imageId], references: [id], onDelete: SetNull)
  ceExport              CeExport?        @relation(fields: [exportId], references: [id], onDelete: SetNull)
  
  createdAt             DateTime         @default(now())
  
  @@index([userId])
  @@index([projectId])
  @@index([imageId])
  @@index([exportId])
  @@index([eventType])
  @@index([createdAt])
  @@map("ce_event_log")
}

// ============================================
// WordPress Integration Config (per-project)
// ============================================

model WordPressConfig {
  id                    String   @id @default(cuid())
  projectId             String   @unique
  
  // Connection
  siteUrl               String              // e.g. https://example.com
  authMethod            String   @default("application_password") // application_password | basic_auth
  username              String
  encryptedPassword     String              // AES-256 encrypted app password
  
  // Behavior
  autoInjectAltText     Boolean  @default(true)
  altStrategy           String   @default("seo_optimized") // seo_optimized | accessibility_focused | hybrid
  
  // Status
  lastHealthCheck       DateTime?
  lastHealthStatus      Boolean?
  lastError             String?
  
  // Relations
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([projectId])
  @@map("wordpress_configs")
}

// ============================================
// SURVIVAL LAB - Metadata Survival Study
// ============================================

/// Platforms being tested for metadata preservation (e.g., WordPress, Instagram, etc.)
model SurvivalPlatform {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  category    String   // CMS, Publishing, Proofing, Storage, Transfer, Social
  freeTier    Boolean  @default(true)
  notes       String?  @db.Text
  
  testRuns    SurvivalTestRun[]
  stats       SurvivalPlatformStats?
  trends      SurvivalPlatformTrend[]
  
  createdAt   DateTime @default(now())
  
  @@map("survival_platforms")
}

/// CE-embedded baseline images uploaded by users for testing
model SurvivalBaselineImage {
  id                String   @id @default(cuid())
  userId            String
  label             String   // CE_TEST_01 etc
  originalFilename  String
  storagePath       String   // Supabase Storage path to raw file
  sha256            String
  bytes             BigInt
  width             Int
  height            Int
  
  testRunAssets     SurvivalTestRunAsset[]
  scenarioUploads   SurvivalScenarioUpload[]
  metadataReports   SurvivalMetadataReport[]
  comparisons       SurvivalComparison[]
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@map("survival_baseline_images")
}

/// A test run for a specific platform
model SurvivalTestRun {
  id            String   @id @default(cuid())
  userId        String
  platformId    String
  title         String   // "Phase 1 - Pixieset - Feb 2026"
  accountType   String?  // free/paid + plan name
  status        String   @default("draft") // draft, running, complete
  
  platform      SurvivalPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  assets        SurvivalTestRunAsset[]
  uploads       SurvivalScenarioUpload[]
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([platformId])
  @@map("survival_test_runs")
}

/// Links baseline images to a test run
model SurvivalTestRunAsset {
  id              String   @id @default(cuid())
  testRunId       String
  baselineImageId String
  
  testRun         SurvivalTestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  baselineImage   SurvivalBaselineImage @relation(fields: [baselineImageId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@unique([testRunId, baselineImageId])
  @@index([testRunId])
  @@index([baselineImageId])
  @@map("survival_test_run_assets")
}

/// Files uploaded per scenario (downloaded original, preview, share-link, etc.)
model SurvivalScenarioUpload {
  id                String   @id @default(cuid())
  testRunId         String
  baselineImageId   String
  scenario          String   // upload_original, download_original, download_preview, share_link_download, right_click_save, platform_export, other
  originalFilename  String
  storagePath       String
  sha256            String
  bytes             BigInt
  width             Int
  height            Int
  
  testRun           SurvivalTestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  baselineImage     SurvivalBaselineImage @relation(fields: [baselineImageId], references: [id], onDelete: Cascade)
  metadataReports   SurvivalMetadataReport[]
  comparisons       SurvivalComparison[]
  
  createdAt         DateTime @default(now())
  
  @@index([testRunId])
  @@index([baselineImageId])
  @@map("survival_scenario_uploads")
}

/// Extracted metadata from baseline or scenario files
model SurvivalMetadataReport {
  id                String   @id @default(cuid())
  fileKind          String   // baseline | scenario
  baselineImageId   String
  scenarioUploadId  String?
  
  exifPresent       Boolean
  xmpPresent        Boolean
  iptcPresent       Boolean
  
  creatorValue      String?
  rightsValue       String?
  creditValue       String?
  descriptionValue  String?  @db.Text
  
  encodingOk        Boolean  @default(true)
  notes             String?  @db.Text
  rawJson           Json     @default("{}")
  
  baselineImage     SurvivalBaselineImage @relation(fields: [baselineImageId], references: [id], onDelete: Cascade)
  scenarioUpload    SurvivalScenarioUpload? @relation(fields: [scenarioUploadId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@index([baselineImageId])
  @@index([scenarioUploadId])
  @@map("survival_metadata_reports")
}

/// Comparison between scenario upload and its baseline
model SurvivalComparison {
  id                String   @id @default(cuid())
  baselineImageId   String
  scenarioUploadId  String
  
  survivalScore     Int      // 0-100 (legacy penalty-based)
  creatorOk         Boolean
  rightsOk          Boolean
  creditOk          Boolean
  descriptionOk     Boolean
  dimsChanged       Boolean
  filenameChanged   Boolean
  fieldsMissing     Json     @default("[]") // list of missing fields
  
  // v2 additions — weighted canonical scoring
  scoreV2           Int?     // 0-100 (weighted canonical-field score)
  survivalClass     String?  // PRISTINE | SAFE | DEGRADED | HOSTILE | DESTRUCTIVE
  diffReport        Json?    // Full MetadataDiffReport (field-level diff)
  
  baselineImage     SurvivalBaselineImage @relation(fields: [baselineImageId], references: [id], onDelete: Cascade)
  scenarioUpload    SurvivalScenarioUpload @relation(fields: [scenarioUploadId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  
  @@unique([scenarioUploadId])
  @@index([baselineImageId])
  @@map("survival_comparisons")
}

/// Aggregated statistics per platform (updated after each scenario upload)
model SurvivalPlatformStats {
  id              String   @id @default(cuid())
  platformId      String
  
  totalRuns       Int      @default(0)
  totalScenarios  Int      @default(0)
  avgScore        Float    @default(0)     // legacy score average
  avgScoreV2      Float    @default(0)     // v2 weighted average
  bestScore       Int      @default(0)
  worstScore      Int      @default(100)
  
  // Container retention rates (0.0 – 1.0)
  exifRetention   Float    @default(0)
  xmpRetention    Float    @default(0)
  iptcRetention   Float    @default(0)
  
  // Field survival counts
  creatorSurvived   Int    @default(0)
  creatorTotal      Int    @default(0)
  copyrightSurvived Int    @default(0)
  copyrightTotal    Int    @default(0)
  creditSurvived    Int    @default(0)
  creditTotal       Int    @default(0)
  descSurvived      Int    @default(0)
  descTotal         Int    @default(0)
  
  platform        SurvivalPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  
  @@unique([platformId])
  @@map("survival_platform_stats")
}

/// Time-series trend data per platform (one row per scenario upload)
model SurvivalPlatformTrend {
  id              String   @id @default(cuid())
  platformId      String
  scenarioUploadId String
  
  score           Int      // legacy score
  scoreV2         Int?     // v2 weighted score
  survivalClass   String?
  scenario        String   // upload_original, download_preview, etc.
  
  platform        SurvivalPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([platformId, createdAt])
  @@map("survival_platform_trends")
}

// ============================================
// Support Operator
// ============================================

/// Support tickets generated by the CE Support Operator
model CeSupportTicket {
  id                String   @id @default(cuid())
  userId            String
  
  // Ticket content
  category          String?
  userMessage       String   @db.Text
  matchedPlaybook   String?
  
  // Context snapshot at time of ticket creation
  contextSnapshot   Json     @default("{}")
  
  // Environment info from client
  environment       Json     @default("{}")
  
  // Status
  status            String   @default("open") // open, resolved, escalated
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("ce_support_tickets")
}

// ============================================
// Public Verification Logs (Forensic-Grade Audit Trail)
// ============================================

/// Append-only log of all public verification attempts.
/// Used for rate limiting, abuse detection, and dispute resolution.
model VerificationLog {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  verificationToken   String   @db.Uuid
  assetId             String
  projectId           String?
  
  checkedAt           DateTime @default(now()) @db.Timestamptz
  ipHash              String   // SHA-256 of IP, never raw IP
  userAgent           String?  @db.VarChar(300)
  result              String   // verified, revoked, not_found, rate_limited
  checksumProvided    Boolean  @default(false)
  checksumMatched     Boolean?
  
  // Relation to growth_images
  growthImage         GrowthImage? @relation(fields: [verificationToken], references: [verificationToken], onDelete: SetNull)
  
  @@index([verificationToken, checkedAt])
  @@index([assetId])
  @@index([ipHash, checkedAt])
  @@map("verification_logs")
}
